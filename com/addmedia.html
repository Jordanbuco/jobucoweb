<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Imagen a GitHub</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Estilo para la ventana flotante */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none; /* Ocultar por defecto */
        }

        .modal.show {
            display: block; /* Mostrar cuando sea necesario */
        }

        .modal button {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div x-data="uploadToGithub()" class="p-4">
    <h1>Subir Imagen a GitHub</h1>

    <input type="file" @change="handleFile" accept="image/*" class="mb-2">
    
    <!-- Campo de texto para ingresar el nuevo nombre de la imagen -->
    <input type="text" x-model="newFileName" placeholder="Nuevo nombre de la imagen" class="mb-2">
    
    <input type="text" x-model="commitMessage" placeholder="Mensaje del commit" class="mb-2">
    
    <button @click="uploadFile" class="bg-blue-500 text-white px-4 py-2">Subir a GitHub</button>

    <div x-show="uploading" class="mt-4">Subiendo archivo...</div>
    <div x-show="success" class="mt-4 text-green-500">Imagen subida con éxito!</div>
    <div x-show="error" class="mt-4 text-red-500">Error al subir la imagen: <span x-text="errorMessage"></span></div>

    <!-- Ventana flotante para mostrar la ruta del archivo -->
    <div class="modal" :class="{ 'show': showModal }">
        <p>Ruta del archivo: <span x-text="filePath"></span></p>
        <button @click="copyToClipboard">Copiar Ruta</button>
        <button @click="showModal = false">Cerrar</button>
    </div>
</div>

<script>
    function uploadToGithub() {
        return {
            token: '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',  // Reemplazar por tu token personal
            repoOwner: 'Jordanbuco',     // Dueño del repositorio
            repoName: 'Drive',           // Nombre del repositorio
            branch: 'main',              // Rama (branch)
            filePath: '',
            fileContent: '',
            newFileName: '',             // Nuevo nombre de la imagen
            commitMessage: '',
            uploading: false,
            success: false,
            error: false,
            errorMessage: '',            // Almacena el mensaje de error
            showModal: false,            // Controla la visibilidad de la ventana flotante

            handleFile(event) {
                const file = event.target.files[0];
                if (file) {
                    // Previsualiza el nombre del archivo subido (temporal)
                    this.filePath = `jobuco/upfromweb/${file.name}`;  // Por defecto, usa el nombre original del archivo
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Convertir el archivo a Base64
                        this.fileContent = btoa(e.target.result);
                    };
                    reader.readAsBinaryString(file);
                }
            },

            async uploadFile() {
                // Si se ha ingresado un nuevo nombre, lo usamos
                if (this.newFileName.trim() !== '') {
                    // Asegúrate de que el nuevo nombre tiene una extensión válida
                    if (!this.newFileName.includes('.')) {
                        alert('Por favor, agrega una extensión al nuevo nombre del archivo (ej. .png, .jpg).');
                        return;
                    }
                    this.filePath = `jobuco/upfromweb/${this.newFileName}`;  // Usa el nuevo nombre
                }

                if (!this.repoOwner || !this.repoName || !this.branch || !this.fileContent || !this.commitMessage) {
                    alert('Por favor completa todos los campos.');
                    return;
                }

                this.uploading = true;
                this.success = false;
                this.error = false;
                this.errorMessage = '';

                const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.filePath}`;

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${this.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: this.commitMessage,
                            content: this.fileContent,
                            branch: this.branch,
                        }),
                    });

                    const result = await response.json();  // Captura la respuesta en JSON

                    this.uploading = false;

                    if (response.ok) {
                        this.success = true;
                        this.showModal = true;  // Muestra la ventana flotante
                    } else {
                        this.error = true;
                        this.errorMessage = result.message || 'Error desconocido';  // Muestra el mensaje de error
                        console.error('Error al subir la imagen:', result.message);
                    }
                } catch (err) {
                    this.uploading = false;
                    this.error = true;
                    this.errorMessage = err.message;
                    console.error('Error al realizar la solicitud:', err);
                }
            },

            copyToClipboard() {
                navigator.clipboard.writeText(this.filePath)
                    .then(() => {
                        alert('Ruta copiada al portapapeles!');
                    })
                    .catch(err => {
                        alert('Error al copiar la ruta: ' + err);
                    });
            }
        }
    }
</script>

</body>
</html>